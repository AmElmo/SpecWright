# Privacy Settings Management

**Issue ID**: ENG-004  
**Project**: User Profile Management (#011)  
**Status**: Pending  
**Priority**: Medium  
**Complexity Score**: 5/10  
**Estimated Hours**: 4h  

## Description

Implement privacy settings management system that allows users to control field-level visibility of their profile information. This includes API endpoints for getting and updating privacy settings, enforcement of privacy rules in public profile endpoints, and default privacy settings for new users.

## Acceptance Criteria

- [ ] GET /api/v1/profile/privacy returns all privacy settings for current user
- [ ] PATCH /api/v1/profile/privacy updates individual field privacy
- [ ] Public profile endpoint (GET /api/v1/profile/:userId/public) respects privacy settings
- [ ] Default privacy settings created for new users (email: private, others: public)
- [ ] Privacy changes invalidate appropriate caches
- [ ] Privacy settings cached for performance (1 hour TTL)
- [ ] Batch update endpoint for changing multiple settings at once
- [ ] Privacy preview feature (see profile as others see it)
- [ ] Admin override for moderation purposes (logged in audit table)
- [ ] Integration tests cover all privacy scenarios
- [ ] Documentation updated with privacy rules

## Technical Details

### Database Model

**profile_privacy_settings table:**
- user_id → INT (FK)
- field_name → VARCHAR (enum: email, bio, location, website, profile_picture)
- is_public → BOOLEAN (default false)
- updated_at → TIMESTAMP

### API Endpoints

**GET /api/v1/profile/privacy**
```javascript
// Response
{
  "settings": [
    { "field_name": "email", "is_public": false },
    { "field_name": "bio", "is_public": true },
    { "field_name": "location", "is_public": true },
    { "field_name": "website", "is_public": true },
    { "field_name": "profile_picture", "is_public": true }
  ]
}
```

**PATCH /api/v1/profile/privacy**
```javascript
// Request
{
  "field_name": "email",
  "is_public": false
}

// Response: 200 OK with updated settings
```

**PATCH /api/v1/profile/privacy/bulk**
```javascript
// Request
{
  "settings": [
    { "field_name": "email", "is_public": false },
    { "field_name": "bio", "is_public": false }
  ]
}

// Response: 200 OK with all updated settings
```

**GET /api/v1/profile/:userId/public**
```javascript
// Implementation
async function getPublicProfile(userId, requestingUserId?) {
  const profile = await getUserProfile(userId);
  const privacy = await getPrivacySettings(userId);
  
  // Filter based on privacy settings
  const filteredProfile = {
    id: profile.id,
    full_name: profile.full_name, // Always public
    profile_picture_url: privacy.profile_picture ? profile.profile_picture_url : null,
    email: privacy.email ? profile.email : null,
    bio: privacy.bio ? profile.bio : null,
    location: privacy.location ? profile.location : null,
    website: privacy.website ? profile.website : null
  };
  
  // Remove null fields
  return Object.fromEntries(
    Object.entries(filteredProfile).filter(([_, v]) => v !== null)
  );
}
```

### Default Privacy Settings

**On user registration:**
```javascript
const defaultPrivacySettings = [
  { field_name: 'email', is_public: false },
  { field_name: 'bio', is_public: true },
  { field_name: 'location', is_public: true },
  { field_name: 'website', is_public: true },
  { field_name: 'profile_picture', is_public: true }
];
```

### Privacy Rules

1. **Always Public:**
   - User ID
   - Full name
   - Username (if exists)

2. **User-Controlled:**
   - Email address
   - Bio
   - Location
   - Website
   - Profile picture

3. **Always Private:**
   - Password hash
   - Deletion timestamps
   - Audit logs

### Caching Strategy

**Cache Key:** `privacy:{user_id}`  
**TTL:** 1 hour  
**Invalidation:** On privacy update, clear `privacy:{user_id}` and `public_profile:{user_id}`

## Dependencies

- **ENG-001** - Database schema (profile_privacy_settings table)
- **ENG-002** - Profile API (to integrate privacy enforcement)

## Testing Requirements

### Integration Tests

```javascript
describe('Privacy Settings API', () => {
  describe('GET /api/v1/profile/privacy', () => {
    it('returns all privacy settings for authenticated user');
    it('returns default settings for new user');
    it('returns 401 for unauthenticated request');
  });

  describe('PATCH /api/v1/profile/privacy', () => {
    it('updates privacy setting successfully');
    it('invalidates cache after update');
    it('returns 400 for invalid field_name');
    it('creates setting if doesn\'t exist');
  });

  describe('GET /api/v1/profile/:userId/public', () => {
    it('shows all public fields');
    it('hides all private fields');
    it('includes name and ID regardless of settings');
    it('respects privacy for unauthenticated users');
    it('different visibility for authenticated vs unauthenticated');
  });

  describe('PATCH /api/v1/profile/privacy/bulk', () => {
    it('updates multiple settings at once');
    it('validates all field names');
    it('rolls back on error');
  });
});
```

### Manual Test Scenarios

1. **Basic Privacy Flow:**
   - Set email to private → Verify hidden in public profile
   - Set bio to public → Verify visible in public profile
   - View own profile vs public profile → Verify difference

2. **Cache Verification:**
   - Load public profile → Change privacy → Reload → Verify updated

3. **Default Settings:**
   - Create new user → Verify default privacy settings applied

4. **Bulk Update:**
   - Change all settings to private → Verify all hidden
   - Change all to public → Verify all visible

## Implementation Checklist

- [ ] Create PrivacyController with CRUD methods
- [ ] Create PrivacyService for business logic
- [ ] Implement privacy enforcement in public profile endpoint
- [ ] Create default privacy settings migration/seed
- [ ] Implement cache invalidation on update
- [ ] Add bulk update endpoint
- [ ] Create integration tests
- [ ] Test all privacy scenarios manually
- [ ] Update API documentation
- [ ] Code review
- [ ] Deploy to staging
- [ ] QA testing
- [ ] Deploy to production

## Files to Create/Modify

**New Files:**
- `src/controllers/PrivacyController.ts`
- `src/services/PrivacyService.ts`
- `src/utils/privacyFilter.ts`
- `tests/integration/privacy.test.ts`
- `db/seeds/default_privacy_settings.sql`

**Modified Files:**
- `src/controllers/ProfileController.ts` (add privacy filtering to public endpoint)
- `src/routes/api.ts` (add privacy routes)
- `docs/api.yaml` (update documentation)

## Reference Documents

- Technical Specification: Section 3 (Implementation Notes)
- PRD: Job Story 3 (Manage Privacy Settings)
- Design Brief: Privacy Settings section

## Notes

- Privacy settings should be conservative by default (private unless explicitly made public)
- Consider adding "friends only" visibility level in future
- Monitor database query performance for privacy joins
- Consider caching privacy settings in user session for performance
- Privacy changes should be audited for compliance

## Risks & Mitigation

**Risk**: Privacy enforcement bug exposes private data  
**Mitigation**: Comprehensive tests, code review, security audit

**Risk**: Privacy queries slow down public profile endpoint  
**Mitigation**: Aggressive caching, optimize query with proper indexes

**Risk**: Cache inconsistency shows stale privacy settings  
**Mitigation**: Use centralized Redis, proper invalidation strategy

**Risk**: Users confused by privacy controls  
**Mitigation**: Clear UI labels, preview feature, good defaults

