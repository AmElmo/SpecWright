# Account Deletion & GDPR Compliance

**Issue ID**: ENG-006  
**Project**: User Profile Management (#011)  
**Status**: Pending  
**Priority**: Medium  
**Complexity Score**: 7/10  
**Estimated Hours**: 6h  

## Description

Implement GDPR-compliant account deletion feature with 30-day grace period, data export functionality, and proper data handling. This includes soft delete mechanism, scheduled permanent deletion, email notifications, and compliance with data retention policies.

## Acceptance Criteria

- [ ] POST /api/v1/profile/delete-request initiates account deletion
- [ ] User must re-authenticate (enter password) to confirm deletion
- [ ] deletion_requested_at timestamp set in database
- [ ] Confirmation email sent with cancellation link
- [ ] 30-day grace period before permanent deletion
- [ ] POST /api/v1/profile/cancel-deletion cancels pending deletion
- [ ] POST /api/v1/profile/export-data generates GDPR data export (ZIP file)
- [ ] Data export includes all user data in JSON format
- [ ] Scheduled job runs daily to permanently delete accounts past grace period
- [ ] Permanent deletion removes all user data except audit logs
- [ ] Profile images deleted from S3
- [ ] User sessions invalidated on deletion request
- [ ] Audit logs record all deletion-related actions
- [ ] Frontend shows deletion status and countdown
- [ ] Integration tests cover full deletion lifecycle
- [ ] Legal/compliance review completed

## Technical Details

### Database Changes

**Soft Delete Fields (in users table):**
- deletion_requested_at: TIMESTAMP (NULL = not requested)
- deleted_at: TIMESTAMP (NULL = not deleted, set after grace period)

**Query Modifications:**
```sql
-- All user queries must filter soft-deleted users
WHERE deleted_at IS NULL

-- Find users pending deletion (grace period expired)
WHERE deletion_requested_at IS NOT NULL 
  AND deletion_requested_at < NOW() - INTERVAL '30 days'
  AND deleted_at IS NULL
```

### API Endpoints

**POST /api/v1/profile/delete-request**
```typescript
async deleteRequest(req: Request) {
  // Verify password
  const isValid = await verifyPassword(req.user.id, req.body.password);
  if (!isValid) throw new UnauthorizedError();
  
  // Set deletion timestamp
  await db.query(
    'UPDATE users SET deletion_requested_at = NOW() WHERE id = $1',
    [req.user.id]
  );
  
  // Send confirmation email with cancellation link
  await emailService.sendDeletionConfirmation(req.user.email, {
    cancellationLink: generateCancellationToken(),
    scheduledDate: addDays(new Date(), 30)
  });
  
  // Invalidate all sessions
  await sessionService.invalidateAllSessions(req.user.id);
  
  // Audit log
  await auditLog.create({
    user_id: req.user.id,
    action: 'account_deletion_requested',
    ip: req.ip,
    user_agent: req.headers['user-agent']
  });
  
  return {
    deletion_requested_at: new Date(),
    deletion_scheduled_for: addDays(new Date(), 30),
    grace_period_days: 30
  };
}
```

**POST /api/v1/profile/cancel-deletion**
```typescript
async cancelDeletion(req: Request) {
  // Clear deletion timestamp
  await db.query(
    'UPDATE users SET deletion_requested_at = NULL WHERE id = $1',
    [req.user.id]
  );
  
  // Send cancellation confirmation
  await emailService.sendDeletionCancelled(req.user.email);
  
  // Audit log
  await auditLog.create({
    user_id: req.user.id,
    action: 'account_deletion_cancelled',
    ip: req.ip
  });
  
  return { message: 'Account deletion cancelled successfully' };
}
```

**POST /api/v1/profile/export-data**
```typescript
async exportData(req: Request) {
  const userId = req.user.id;
  
  // Gather all user data
  const userData = {
    profile: await getProfile(userId),
    privacy_settings: await getPrivacySettings(userId),
    notification_preferences: await getNotificationPreferences(userId),
    audit_logs: await getAuditLogs(userId),
    created_at: req.user.created_at,
    last_login: req.user.last_login
  };
  
  // Create ZIP file
  const zip = new JSZip();
  zip.file('user_data.json', JSON.stringify(userData, null, 2));
  zip.file('README.txt', getDataExportReadme());
  
  const zipBuffer = await zip.generateAsync({ type: 'nodebuffer' });
  
  // Audit log
  await auditLog.create({
    user_id: userId,
    action: 'data_export_requested',
    ip: req.ip
  });
  
  // Return ZIP file
  res.setHeader('Content-Type', 'application/zip');
  res.setHeader('Content-Disposition', `attachment; filename=user_data_${userId}.zip`);
  return zipBuffer;
}
```

### Scheduled Deletion Job

**Cron Job (runs daily at 2am):**
```typescript
// Schedule: 0 2 * * * (daily at 2am)
async function permanentlyDeleteExpiredAccounts() {
  const expiredUsers = await db.query(`
    SELECT id, email, profile_picture_url 
    FROM users 
    WHERE deletion_requested_at IS NOT NULL 
      AND deletion_requested_at < NOW() - INTERVAL '30 days'
      AND deleted_at IS NULL
  `);
  
  for (const user of expiredUsers) {
    try {
      // Delete profile images from S3
      if (user.profile_picture_url) {
        await s3Service.deleteUserImages(user.id);
      }
      
      // Delete related data (CASCADE handles most)
      // But explicitly delete sensitive data
      await db.query('DELETE FROM profile_audit_log WHERE user_id = $1', [user.id]);
      
      // Soft delete (keep for audit, anonymize)
      await db.query(`
        UPDATE users 
        SET 
          deleted_at = NOW(),
          email = CONCAT('deleted_', id, '@example.com'),
          full_name = 'Deleted User',
          bio = NULL,
          location = NULL,
          website = NULL,
          profile_picture_url = NULL
        WHERE id = $1
      `, [user.id]);
      
      // Send final confirmation email
      await emailService.sendDeletionComplete(user.email);
      
      logger.info(`Permanently deleted user ${user.id}`);
    } catch (error) {
      logger.error(`Failed to delete user ${user.id}:`, error);
      // Continue with other users
    }
  }
}
```

### GDPR Compliance Checklist

- [ ] **Right to Access**: Data export endpoint
- [ ] **Right to Rectification**: Profile edit API
- [ ] **Right to Erasure**: Account deletion
- [ ] **Right to Data Portability**: Data export in JSON
- [ ] **Right to Object**: Notification preferences
- [ ] **Data Breach Notification**: Audit logs
- [ ] **Consent Management**: Privacy settings
- [ ] **Data Retention**: 30-day grace period, then permanent deletion

### Email Templates

**Deletion Confirmation:**
```
Subject: Account Deletion Requested

Your account deletion has been scheduled for [DATE].

You have 30 days to change your mind. If you want to keep your account, 
click here: [CANCELLATION LINK]

After [DATE], your account and all associated data will be permanently deleted.

You can download your data here: [EXPORT LINK]
```

**Deletion Cancelled:**
```
Subject: Account Deletion Cancelled

Good news! Your account deletion has been cancelled. Your account is active again.
```

**Deletion Complete:**
```
Subject: Account Deleted

Your account has been permanently deleted. All your data has been removed from our systems.

If this was a mistake, please contact support within 7 days.
```

## Dependencies

- **ENG-001** - Database schema (deletion timestamp columns)
- **ENG-002** - Profile API (for data gathering)

## Testing Requirements

### Integration Tests

```typescript
describe('Account Deletion', () => {
  test('delete request sets timestamp and sends email', async () => {
    const response = await api.post('/profile/delete-request', {
      password: 'correct_password'
    });
    
    expect(response.status).toBe(200);
    expect(response.data.grace_period_days).toBe(30);
    expect(mockEmailService.sendDeletionConfirmation).toHaveBeenCalled();
  });

  test('cannot delete with wrong password', async () => {
    const response = await api.post('/profile/delete-request', {
      password: 'wrong_password'
    });
    
    expect(response.status).toBe(401);
  });

  test('cancel deletion clears timestamp', async () => {
    await api.post('/profile/delete-request', { password: 'test123' });
    const response = await api.post('/profile/cancel-deletion');
    
    expect(response.status).toBe(200);
    const user = await getUser();
    expect(user.deletion_requested_at).toBeNull();
  });

  test('data export includes all user data', async () => {
    const response = await api.post('/profile/export-data');
    
    expect(response.headers['content-type']).toBe('application/zip');
    const zip = await JSZip.loadAsync(response.data);
    const userData = JSON.parse(await zip.file('user_data.json').async('string'));
    expect(userData).toHaveProperty('profile');
    expect(userData).toHaveProperty('privacy_settings');
  });
});

describe('Scheduled Deletion Job', () => {
  test('deletes users past grace period', async () => {
    const user = await createUser({ deletion_requested_at: subDays(new Date(), 31) });
    await runScheduledDeletionJob();
    
    const deletedUser = await getUser(user.id);
    expect(deletedUser.deleted_at).not.toBeNull();
    expect(deletedUser.email).toContain('deleted_');
  });

  test('does not delete users within grace period', async () => {
    const user = await createUser({ deletion_requested_at: subDays(new Date(), 15) });
    await runScheduledDeletionJob();
    
    const user2 = await getUser(user.id);
    expect(user2.deleted_at).toBeNull();
  });
});
```

### Manual Test Scenarios

1. **Complete Deletion Flow:**
   - Request deletion → Verify email received
   - Wait for grace period (simulate by changing timestamp) → Verify deletion
   - Check S3 → Verify images deleted
   - Try to login → Verify account inactive

2. **Cancellation Flow:**
   - Request deletion → Cancel within grace period → Verify account active
   - Try to login → Verify still works

3. **Data Export:**
   - Request data export → Download ZIP → Verify all data included
   - Check JSON format → Verify valid and complete

4. **Edge Cases:**
   - Request deletion twice → Verify idempotent
   - Cancel without active deletion → Verify handled gracefully
   - Export data then delete → Verify works

## Implementation Checklist

- [ ] Implement deletion request endpoint
- [ ] Implement cancellation endpoint
- [ ] Implement data export endpoint
- [ ] Create email templates for deletion notifications
- [ ] Implement scheduled deletion job (node-cron or similar)
- [ ] Add S3 cleanup logic
- [ ] Create integration tests
- [ ] Test scheduled job manually
- [ ] Review GDPR compliance with legal team
- [ ] Update privacy policy documentation
- [ ] Code review
- [ ] Deploy scheduled job to production
- [ ] Monitor scheduled job execution
- [ ] Deploy API endpoints
- [ ] QA testing
- [ ] User acceptance testing

## Files to Create/Modify

**New Files:**
- `src/controllers/DeletionController.ts`
- `src/services/DeletionService.ts`
- `src/services/DataExportService.ts`
- `src/jobs/scheduledDeletion.ts`
- `src/templates/email/deletion_confirmation.html`
- `src/templates/email/deletion_cancelled.html`
- `src/templates/email/deletion_complete.html`
- `tests/integration/deletion.test.ts`

**Modified Files:**
- `src/routes/api.ts` (add deletion routes)
- `src/app.ts` (register scheduled job)
- `package.json` (add node-cron, jszip)
- `docs/gdpr_compliance.md` (document compliance)

## Reference Documents

- Technical Specification: Section 7 (Rabbit Holes - avoiding over-engineering)
- PRD: Job Story 6 (Delete Account)
- GDPR Article 17 (Right to Erasure)

## Notes

- Grace period protects against accidental deletions
- Keep audit logs even after deletion (for legal compliance)
- Anonymize rather than hard delete for referential integrity
- Monitor scheduled job - set up alerts if it fails
- Consider adding admin override for manual deletions
- Profile images in S3 should have lifecycle policy as backup

## Risks & Mitigation

**Risk**: Scheduled job fails, accounts not deleted  
**Mitigation**: Monitoring alerts, manual fallback process, idempotent job

**Risk**: User requests deletion by mistake  
**Mitigation**: 30-day grace period, clear email warnings, easy cancellation

**Risk**: GDPR non-compliance  
**Mitigation**: Legal review, comprehensive audit logs, data export feature

**Risk**: S3 deletion fails leaving orphaned files  
**Mitigation**: Retry logic, separate cleanup job, lifecycle policies

**Risk**: Permanent deletion accidentally deletes wrong user  
**Mitigation**: Thorough testing, audit logs, admin approval for manual deletions

