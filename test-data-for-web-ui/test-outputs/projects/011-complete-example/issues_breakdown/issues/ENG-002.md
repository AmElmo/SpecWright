# Profile API Endpoints

**Issue ID**: ENG-002  
**Project**: User Profile Management (#011)  
**Status**: Pending  
**Priority**: High  
**Complexity Score**: 8/10  
**Estimated Hours**: 10h  

## Description

Implement core REST API endpoints for profile management including GET, PATCH for profile data, password change endpoint, notification preferences endpoints, and public profile endpoint. All endpoints must include proper authentication, validation, rate limiting, and caching.

## Acceptance Criteria

- [ ] GET /api/v1/profile returns current user's profile with privacy settings
- [ ] PATCH /api/v1/profile updates profile fields with validation
- [ ] POST /api/v1/profile/password changes password with session invalidation
- [ ] GET /api/v1/profile/notifications returns notification preferences
- [ ] PATCH /api/v1/profile/notifications updates preferences
- [ ] GET /api/v1/profile/:userId/public returns public profile respecting privacy
- [ ] All endpoints have proper error handling (400, 401, 403, 409, 429, 500)
- [ ] Rate limiting implemented (profile updates: 10/hour, password: 3/hour)
- [ ] Redis caching implemented for profile data (5 min TTL)
- [ ] Input validation prevents XSS and SQL injection
- [ ] All changes logged to audit table
- [ ] Email notifications sent for critical changes (email change, password change)
- [ ] API documentation updated (Swagger/OpenAPI)
- [ ] Integration tests cover all endpoints and error cases

## Technical Details

### Endpoints to Implement

**GET /api/v1/profile**
- Auth: Required (JWT)
- Returns: Profile object with privacy settings
- Cache: 5 minutes in Redis
- Performance target: < 200ms

**PATCH /api/v1/profile**
- Auth: Required
- Body: { full_name?, email?, bio?, location?, website? }
- Validation: email uniqueness, field lengths, URL format
- Side effects: Invalidate cache, send email if email changed, audit log
- Rate limit: 10 requests per hour
- Performance target: < 500ms

**POST /api/v1/profile/password**
- Auth: Required
- Body: { current_password, new_password, new_password_confirm }
- Validation: Password strength (zxcvbn), current password correct, passwords match
- Side effects: Invalidate all sessions except current, send email, audit log
- Rate limit: 3 requests per hour
- Performance target: < 1s (bcrypt is slow)

**GET /api/v1/profile/notifications**
- Auth: Required
- Returns: Notification preferences grouped by channel
- Cache: 1 hour in Redis

**PATCH /api/v1/profile/notifications**
- Auth: Required
- Body: { channel, category, enabled }
- Side effects: Invalidate cache
- Auto-save (no explicit confirmation needed)

**GET /api/v1/profile/:userId/public**
- Auth: Optional (affects visibility)
- Returns: Profile object filtered by privacy settings
- Cache: 1 hour in Redis + CloudFront
- Performance target: < 200ms

### Validation Rules

**Email:**
```javascript
validator.isEmail(email) &&
email.length <= 255 &&
!(await isEmailTaken(email, currentUserId))
```

**Password:**
```javascript
password.length >= 8 &&
zxcvbn(password).score >= 3 &&
/[A-Z]/.test(password) &&
/[a-z]/.test(password) &&
/[0-9]/.test(password) &&
/[^A-Za-z0-9]/.test(password)
```

**Bio:** Max 500 chars, HTML stripped  
**Location:** Max 100 chars  
**Website:** Valid URL, max 255 chars, HTTPS preferred

### Caching Strategy

**Cache Keys:**
- `profile:{user_id}` - Full profile (5 min)
- `privacy:{user_id}` - Privacy settings (1 hour)
- `notif_prefs:{user_id}` - Notification prefs (1 hour)
- `public_profile:{user_id}` - Public view (1 hour)

**Invalidation:**
- Profile update → Invalidate `profile:*` and `public_profile:*`
- Privacy change → Invalidate `privacy:*` and `public_profile:*`
- Notification change → Invalidate `notif_prefs:*`

## Dependencies

- **ENG-001** - Database schema must be ready

## Testing Requirements

### Integration Tests (Supertest)

```javascript
describe('Profile API', () => {
  describe('GET /api/v1/profile', () => {
    it('returns profile for authenticated user');
    it('returns 401 for unauthenticated request');
    it('includes privacy settings in response');
  });

  describe('PATCH /api/v1/profile', () => {
    it('updates profile fields successfully');
    it('returns 400 for invalid email');
    it('returns 409 for duplicate email');
    it('sends email notification when email changes');
    it('respects rate limit (10 per hour)');
    it('invalidates cache after update');
  });

  describe('POST /api/v1/profile/password', () => {
    it('changes password successfully');
    it('returns 401 for incorrect current password');
    it('returns 400 for weak password');
    it('invalidates all sessions except current');
    it('sends email notification');
    it('respects rate limit (3 per hour)');
  });

  describe('GET /api/v1/profile/:userId/public', () => {
    it('returns only public fields');
    it('hides private fields from response');
    it('returns different data for authenticated vs unauthenticated');
  });
});
```

### Manual Tests

1. **Profile Update Flow**
   - Login → Update name → Verify change persists
   - Update email → Verify confirmation email sent
   - Try duplicate email → Verify error message

2. **Password Change Flow**
   - Change password → Verify logged out of other devices
   - Use wrong current password → Verify error
   - Use weak password → Verify strength error

3. **Rate Limiting**
   - Make 11 profile updates in hour → Verify 429 error
   - Make 4 password attempts in hour → Verify 429 error

4. **Caching**
   - Update profile → Check cache invalidated
   - Make same request twice → Verify cache hit

## Implementation Checklist

- [ ] Create controller files (ProfileController, PasswordController, NotificationController)
- [ ] Create service layer (ProfileService, EmailService, AuditService)
- [ ] Implement validation middleware with validator.js
- [ ] Implement rate limiting middleware with express-rate-limit + Redis
- [ ] Implement caching layer with ioredis
- [ ] Add error handling middleware
- [ ] Create integration tests
- [ ] Test all endpoints manually in Postman
- [ ] Update API documentation (Swagger)
- [ ] Code review
- [ ] Deploy to staging
- [ ] QA testing
- [ ] Deploy to production

## Files to Create/Modify

**New Files:**
- `src/controllers/ProfileController.ts`
- `src/controllers/PasswordController.ts`
- `src/controllers/NotificationController.ts`
- `src/services/ProfileService.ts`
- `src/services/AuditService.ts`
- `src/middleware/rateLimit.ts`
- `src/middleware/validateProfile.ts`
- `src/middleware/cache.ts`
- `tests/integration/profile.test.ts`

**Modified Files:**
- `src/routes/api.ts` (add new routes)
- `src/app.ts` (register middleware)
- `docs/api.yaml` (update Swagger)

## Reference Documents

- Technical Specification: Sections 2 (API), 3 (Implementation), 5 (Non-Functional Requirements)
- PRD: All Job Stories (for understanding acceptance criteria)

## Notes

- Use TypeScript interfaces for type safety
- Follow existing API patterns in codebase
- Ensure all errors logged to Sentry
- Use existing authentication middleware
- Consider adding feature flag for gradual rollout
- Password hashing is slow (bcrypt) - consider moving to background job if response time > 2s

## Risks & Mitigation

**Risk**: Rate limiting breaks under load  
**Mitigation**: Load test rate limiter, use Redis cluster if needed

**Risk**: Cache inconsistency across multiple servers  
**Mitigation**: Use centralized Redis, not in-memory cache

**Risk**: Email sending failures block API responses  
**Mitigation**: Send emails asynchronously, retry with job queue

**Risk**: Password change invalidates current session by accident  
**Mitigation**: Carefully implement session filtering logic, test thoroughly

