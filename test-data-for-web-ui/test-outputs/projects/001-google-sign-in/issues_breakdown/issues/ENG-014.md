# Write integration tests for API endpoints

**Issue ID**: ENG-014  
**Status**: pending  
**Priority**: medium  
**Category**: testing  
**Complexity Score**: 7/10  
**Estimated Hours**: 8h  
**Complexity Reasoning**: Complex integration testing with database, Redis, and mocked external APIs

> **Status Options**: `pending` (not started) | `in-review` (AI completed, needs human review) | `approved` (human verified)

## Description

Test full authentication flow with Supertest and mocked Google API. Test all endpoints together with real database and Redis connections.

## Technical Details

Integration tests should:
- Spin up test server
- Connect to test database
- Use test Redis instance
- Mock Google OAuth endpoints
- Test complete auth flow end-to-end
- Clean up after each test

```typescript
describe('Auth Integration Tests', () => {
  let server;
  let testDb;
  
  beforeAll(async () => {
    server = createTestServer();
    testDb = await setupTestDatabase();
  });
  
  afterAll(async () => {
    await teardownTestDatabase();
    server.close();
  });
  
  describe('POST /auth/google', () => {
    it('initiates OAuth flow', async () => {
      const response = await request(server)
        .get('/auth/google')
        .expect(302);
      
      expect(response.headers.location).toContain('accounts.google.com');
    });
  });
  
  describe('Complete Auth Flow', () => {
    it('logs in user and creates session', async () => {
      // Mock complete OAuth flow
      // Verify user in database
      // Verify session in Redis
      // Verify JWT returned
    });
  });
});
```

## Dependencies

- **ENG-013**: Unit tests should be complete first

## Acceptance Criteria

- [ ] Test server configured
- [ ] Test database with migrations
- [ ] Test Redis instance
- [ ] Google OAuth mocked
- [ ] Complete auth flow tested
- [ ] Protected endpoints tested
- [ ] Logout flow tested
- [ ] Error scenarios tested
- [ ] Tests are deterministic and isolated
- [ ] Can run in CI/CD

## Test Strategy

### Automated Tests

- Full OAuth flow from start to finish
- Protected endpoint access with valid token
- Protected endpoint rejection without token
- Logout flow
- Token refresh (if implemented)
- Multiple concurrent users
- Session expiration

### Manual Verification (Human-in-the-Loop)

1. Run integration test suite
2. Verify tests don't interfere with each other
3. Check test database is cleaned up
4. Verify tests run consistently
5. Review test logs for any warnings

## Subtasks

1. Set up test database
2. Configure test Redis
3. Create test server setup
4. Mock Google OAuth
5. Write auth flow tests
6. Write protected endpoint tests
7. Write logout tests
8. Add test cleanup
9. Configure CI/CD pipeline

---

**Notes**: Use docker-compose for consistent test environment. Consider parallel test execution for faster CI.




