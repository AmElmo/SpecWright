# Implement backend OAuth endpoints

**Issue ID**: ENG-004  
**Status**: in-review  
**Priority**: critical  
**Category**: backend  
**Complexity Score**: 8/10  
**Estimated Hours**: 8h  
**Complexity Reasoning**: Complex OAuth flow implementation with error handling, state validation, and security considerations

> **Status Options**: `pending` (not started) | `in-review` (AI completed, needs human review) | `approved` (human verified)

## Description

Create `/auth/google` and `/auth/google/callback` endpoints using Passport.js to handle the complete OAuth 2.0 authorization code flow with Google. Implement proper error handling, state validation, and user creation/update logic.

## Technical Details

Implement two endpoints:

1. **GET /auth/google**: Initiates OAuth flow
   - Redirect user to Google consent screen
   - Generate and store CSRF state token
   - Request appropriate scopes (email, profile)

2. **GET /auth/google/callback**: Handles OAuth callback
   - Validate state parameter (CSRF protection)
   - Exchange authorization code for access token
   - Fetch user profile from Google
   - Create or update user in database
   - Create session and set session cookie
   - Redirect to application

Use Passport.js GoogleStrategy:
```typescript
import passport from 'passport';
import { Strategy as GoogleStrategy } from 'passport-google-oauth20';

passport.use(new GoogleStrategy({
  clientID: process.env.GOOGLE_CLIENT_ID!,
  clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
  callbackURL: '/auth/google/callback',
  scope: ['email', 'profile']
}, async (accessToken, refreshToken, profile, done) => {
  // Create or update user logic
}));
```

## Dependencies

- **ENG-001**: OAuth credentials must be configured
- **ENG-002**: Database schema must exist
- **ENG-003**: Redis session store must be running

## Acceptance Criteria

- [ ] `/auth/google` endpoint redirects to Google consent screen
- [ ] Callback endpoint validates state parameter
- [ ] User profile data is fetched from Google
- [ ] User record created in database if new
- [ ] Existing user record updated with latest data
- [ ] Session created and stored in Redis
- [ ] Proper error handling for failed OAuth flow
- [ ] CSRF protection implemented
- [ ] Secure session cookies configured

## Test Strategy

### Automated Tests

- Mock Google OAuth endpoints
- Test successful OAuth flow creates user and session
- Test failed authorization redirects properly
- Test state parameter validation
- Test duplicate user handling (email already exists)
- Test session creation in Redis

### Manual Verification (Human-in-the-Loop)

1. Click "Sign in with Google" button
2. Verify redirect to Google consent screen
3. Approve permissions and verify callback
4. Check database for user record creation
5. Verify session exists in Redis
6. Verify user is logged in (session cookie set)
7. Test error scenarios (deny permissions, invalid state)

## Subtasks

1. Install Passport.js and Google OAuth strategy
2. Configure Passport with GoogleStrategy
3. Implement /auth/google endpoint
4. Implement /auth/google/callback endpoint
5. Add user creation/update logic
6. Implement state validation for CSRF protection
7. Configure session serialization
8. Add comprehensive error handling
9. Test complete flow end-to-end

---

**Notes**: Store only necessary user data. Consider implementing token refresh if you need long-term API access. Ensure all redirects use HTTPS in production.

## Implementation Notes

*This section filled during development*

Code has been implemented with proper error boundaries and logging. All dependencies satisfied and tests passing locally.




