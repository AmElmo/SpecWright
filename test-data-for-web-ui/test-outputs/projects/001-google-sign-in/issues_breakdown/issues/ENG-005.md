# Implement JWT token generation and validation

**Issue ID**: ENG-005  
**Status**: in-review  
**Priority**: critical  
**Category**: backend  
**Complexity Score**: 6/10  
**Estimated Hours**: 5h  
**Complexity Reasoning**: JWT implementation with proper security, expiration handling, and middleware integration

> **Status Options**: `pending` (not started) | `in-review` (AI completed, needs human review) | `approved` (human verified)

## Description

Set up JWT (JSON Web Token) token generation after successful OAuth authentication and create middleware to validate tokens on protected API endpoints. Implement token refresh strategy.

## Technical Details

1. Generate JWT after successful OAuth callback
2. Include user ID and essential claims in payload
3. Set appropriate expiration (e.g., 1 hour for access token)
4. Create middleware to validate JWT on protected routes
5. Optional: Implement refresh tokens for extended sessions

JWT structure:
```typescript
import jwt from 'jsonwebtoken';

const generateToken = (userId: string) => {
  return jwt.sign(
    { userId, type: 'access' },
    process.env.JWT_SECRET!,
    { expiresIn: '1h' }
  );
};

const verifyToken = (token: string) => {
  return jwt.verify(token, process.env.JWT_SECRET!);
};
```

Middleware:
```typescript
const authenticateJWT = (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1];
  if (!token) return res.status(401).json({ error: 'Unauthorized' });
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET!);
    req.user = decoded;
    next();
  } catch (err) {
    return res.status(403).json({ error: 'Invalid token' });
  }
};
```

## Dependencies

- **ENG-004**: OAuth flow must be complete to trigger JWT generation

## Acceptance Criteria

- [ ] JWT generated after successful OAuth authentication
- [ ] Token includes userId and essential claims
- [ ] Token expiration properly configured
- [ ] Validation middleware created
- [ ] Middleware attached to protected routes
- [ ] Invalid/expired tokens rejected with proper error
- [ ] JWT secret stored securely in environment variable
- [ ] Token included in Authorization header format

## Test Strategy

### Automated Tests

- Valid JWT passes authentication middleware
- Expired JWT is rejected
- Tampered JWT is rejected
- Missing JWT returns 401 Unauthorized
- Token payload includes correct user data

### Manual Verification (Human-in-the-Loop)

1. Complete OAuth flow and receive JWT
2. Use JWT in Authorization header on protected endpoint
3. Verify access is granted with valid token
4. Try accessing without token (should fail)
5. Try with expired token (should fail)
6. Verify token expiration timing

## Subtasks

1. Install jsonwebtoken package
2. Create token generation utility
3. Integrate token generation into OAuth callback
4. Create authentication middleware
5. Apply middleware to protected routes
6. Implement error handling for invalid tokens
7. Add token to API response after login
8. Test token validation

---

**Notes**: Use strong, randomly generated JWT secret. Consider implementing refresh tokens if sessions need to last longer than access token expiration. Store JWT in httpOnly cookies for better security than localStorage.

## Implementation Notes

Implemented with RS256 algorithm for better security. Refresh token strategy added with 7-day expiration.




